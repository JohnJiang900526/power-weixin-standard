webpackJsonp([2],{EEJi:function(e,t){},S9wd:function(e,t){},XMtk:function(e,t){},iI4X:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=s("Gu7T"),n=s.n(o),c=s("woOf"),i=s.n(c),r=s("mvHQ"),a=s.n(r),l=s("Dd8w"),u=s.n(l),d=s("NYxO"),h=s("tiSE"),f=s("GUsc"),v=s("undV"),p=s("W/7t"),w=s("ALGc"),k=s("rHil"),C={name:"x-switch",methods:{toBoolean:function(e){return this.valueMap?1===this.valueMap.indexOf(e):e},toRaw:function(e){return this.valueMap?this.valueMap[e?1:0]:e}},props:{disabled:Boolean,value:{type:[Boolean,String,Number],default:!1},valueMap:{type:Array,default:function(){return[!1,!0]}}},data:function(){return{currentValue:this.toBoolean(this.value)}},watch:{currentValue:function(e){var t=this.toRaw(e);this.$emit("input",t),this.$emit("on-change",t)},value:function(e){this.currentValue=this.toBoolean(e)}}},S={render:function(){var e=this,t=e.$createElement;return(e._self._c||t)("input",{directives:[{name:"model",rawName:"v-model",value:e.currentValue,expression:"currentValue"}],staticClass:"inline-x-switch weui-switch",attrs:{type:"checkbox",disabled:e.disabled},domProps:{checked:Array.isArray(e.currentValue)?e._i(e.currentValue,null)>-1:e.currentValue},on:{change:function(t){var s=e.currentValue,o=t.target,n=!!o.checked;if(Array.isArray(s)){var c=e._i(s,null);o.checked?c<0&&(e.currentValue=s.concat([null])):c>-1&&(e.currentValue=s.slice(0,c).concat(s.slice(c+1)))}else e.currentValue=n}}})},staticRenderFns:[]};var m=s("VU/8")(C,S,!1,function(e){s("XMtk")},null,null).exports,_=s("N8Hv"),N=s("Mlu6"),I={name:"workflow",data:function(){return{WorkFlowData:{},WorkFlowList:[],selectedWorkFlows:[],currentWorkFlow:null,NodeLists:[],currentNodeList:null,showPeopleContent:!0,filterNormalNode:!0,currentStop:"",peopleLists:[],MindInfo:"",IsMindMustInput:!0,NextNodeList:[],current:{},positionUserParams:{},byDraft:{users:[],NodeCode:""},ConfigUserList:[],currentRow:{}}},computed:{PeopleContentHeight:function(){return this.showPeopleContent?"calc(60% - 50px)":"0px"},query:function(){return this.$router.history.current.query||{}},formState:function(){return this.query.FormState||""}},mounted:function(){this.getWorkFlowData()},methods:u()({getWorkFlowData:function(){var e=this,t={KeyWord:this.query.KeyWord,KeyValue:this.query.KeyValue,FormId:this.query.FormId,FlowOperate:p.d.SelectFlow,SequeID:this.query.SequeID};this.FlowActionData(a()(t)).then(function(t){var s=t.data.value,o=[];e.WorkFlowData=i()({},s),s&&s.WorkFlowList&&(o=[].concat(n()(s.WorkFlowList))),o.forEach(function(t,n){s.WorkFlowID?s.WorkFlowID===t.WorkFlowID&&e.selectedWorkFlows.push(t):t.IsAutoSelect?e.selectedWorkFlows.push(t):1===o.length&&e.selectedWorkFlows.push(t)}),e.WorkFlowList=[].concat(n()(o)),e.timer&&clearTimeout(e.timer),e.timer=setTimeout(function(){0===e.selectedWorkFlows.length?e.toNextStep("selectFlow"):e.toNextStep("nodeSelect")},300)}).catch(function(t){e.AlertShowEvent(t.message)})},getFlowNode:function(e){var t=this,s=i()({},{WorkFlowID:e.WorkFlowID,Version:e.Version,FormId:this.query.FormId,KeyWord:this.query.KeyWord,KeyValue:this.query.KeyValue,WorkInfoID:e.WorkInfoID?e.WorkInfoID:Object(N.d)()});this.positionUserParams=i()({},{SubOperate:"SaveUserToInstanNode",FlowOperate:"SupplyFlow",Current:s,ConfigUserList:[]});var o=i()({},{SubOperate:"ReadNodeList",FlowOperate:"SupplyFlow",Current:s});this.FlowActionData(a()(o)).then(function(e){var s=e.data.value,o=s&&s.NodeList?[].concat(n()(s.NodeList)):[];o.map(function(e,t){return e.CanSendUsers=JSON.parse(e.CanSendUsers),e}),t.NodeLists=[].concat(n()(o)),0===t._findUnormalNodeList().length&&t.toNextStep("peopleSelect")}).catch(function(e){t.AlertShowEvent(e)})},peopleSelectFlow:function(e){var t=this,s=i()({},{WorkFlowID:e.WorkFlowID,Version:e.Version,PlanEndDate:e.PlanEndDate,FormId:this.query.FormId,KeyWord:this.query.KeyWord,KeyValue:this.query.KeyValue});this.query.WorkInfoID&&(s=i()(s,{WorkInfoID:this.query.WorkInfoID})),this.query.GroupID&&(s=i()(s,{GroupID:this.query.GroupID})),e.WorkInfoID?s=i()(s,{WorkInfoID:e.WorkInfoID}):s.WorkInfoID||(s=i()(s,{WorkInfoID:Object(N.d)()}));var o={Current:s,FlowOperate:p.d.Active};this.FlowActionData(a()(o)).then(function(e){var s=e.data.value,o=[];console.log(s),s&&(o=[].concat(n()(s.NextNodeList))),t.byDraft.users.length>0&&o.forEach(function(e){e.NodeCode===t.byDraft.NodeCode&&(e.CanSelectUsers=[].concat(n()(t.byDraft.users)))}),t.current=i()({},s.Current),t.NextNodeList=t.formatNextNodeList(o)}).catch(function(e){t.AlertShowEvent(e.message)})},submitFlow:function(){var e=this,t=this.getSelectedNode();if(""!==t.error)return this.AlertShowEvent(t.error),!1;if(this.IsMindMustInput&&""===this.MindInfo)return this.AlertShowEvent("审批意见不许为空"),!1;var s=i()(this.current,{KeyWord:this.query.KeyWord,KeyValue:this.query.KeyValue,FormId:this.query.FormId}),o=i()({Current:s,FlowOperate:"Send",MindInfo:this.MindInfo,SelectedNode:t.data,VoteText:"",VoteValue:""});this.FlowActionData(a()(o)).then(function(t){e.GetInformCount().then(function(){"view"===e.formState?e.$router.push("/workinfos"):e.$router.back()}).catch(function(t){e.AlertShowEvent(t.message)})}).catch(function(t){e.AlertShowEvent(t.message)})},toNextStep:function(e){var t=this.getCurrentFlowItem();switch(e){case"selectFlow":this.currentStop=e;break;case"nodeSelect":if(!t)return this.AlertShowEvent("请选择一个流程"),!1;this.currentStop=e,this.getFlowNode(t);break;case"peopleSelect":var s=this._findUnormalNodeList();if(!t)return this.AlertShowEvent("请选择一个流程"),!1;if(s.length>0)return this.AlertShowEvent("节点有异常没有处理"),!1;this.currentStop=e,this.peopleSelectFlow(t);break;default:return!1}},toUpStep:function(e){this.currentStop=e},getSelectedNode:function(){var e=[],t="";return this.NextNodeList.forEach(function(s,o){var n={};n.NodeCode=s.NodeCode,n.SendUserList=[],n.CopyUserList=[],s.CanSelectUsers.forEach(function(e,t){if(e.checked&&!0===e.checked){var s=i()({},e);delete s.checked,n.SendUserList.push(s)}}),s.CanSelectCopyUsers.forEach(function(e,t){if(e.checked&&!0===e.checked){var s=i()({},e);delete s.checked,n.CopyUserList.push(s)}}),0===n.SendUserList.length&&!1===s.IsMustNotUsers&&(t=s.NodeName+"节点没有选择送审人员"),s.checked&&e.push(n)}),0===e.length&&(t="节点数据为空"),{data:e,error:t}},selectCopyUsersEvent:function(e,t){var s=[].concat(n()(this.NextNodeList));s[e].checked?s[e].CanSelectCopyUsers[t].checked=!s[e].CanSelectCopyUsers[t].checked:this.AlertShowEvent("请先选择"+this.NextNodeList[e].NodeName+"节点"),this.NextNodeList=[].concat(n()(s))},selectUsersEvent:function(e,t){var s=[].concat(n()(this.NextNodeList)),o=s[e].checked,c=s[e].AllowMulitUser,i=s[e].SelectUserMode;if(o){if("SelectAllAndDisabled"===i)return this.AlertShowEvent("你没有修改权限"),!1;c?s[e].CanSelectUsers[t].checked=!s[e].CanSelectUsers[t].checked:s[e].CanSelectUsers.forEach(function(e,s){e.checked=s===t&&!e.checked})}else this.AlertShowEvent("请先选择"+s[e].NodeName+"节点");this.NextNodeList=[].concat(n()(s))},nodeListTitleSelect:function(e){var t=this,s=this.NextNodeList,o=s[e].checked,c=s[e].SelectNodeMode,r=s[e].LineType,a=s[e].IsLastReturnNode;switch(c){case"SelectedNode":s[e].checked=!o,s[e]=i()(s[e],this.computedUserIsSelected(s[e])),r===p.c.ExcludeLine&&s.forEach(function(o,n){n!==e&&(s[n].checked=!1,s[n]=i()(s[n],t.computedUserIsSelected(s[n])))}),a&&s.forEach(function(o,n){n!==e&&(s[n].checked=!1,s[n]=i()(s[n],t.computedUserIsSelected(s[n])))});break;case"SelectedAndDisabled":this.AlertShowEvent("禁止取消");break;default:s[e].checked=!o,s[e]=i()(s[e],this.computedUserIsSelected(s[e])),r===p.c.ExcludeLine&&s.forEach(function(o,n){n!==e&&(s[n].checked=!1,s[n]=i()(s[n],t.computedUserIsSelected(s[n])))}),a&&s.forEach(function(o,n){n!==e&&(s[n].checked=!1,s[n]=i()(s[n],t.computedUserIsSelected(s[n])))})}this.NextNodeList=[].concat(n()(s))},formatNextNodeList:function(e){var t=this,s=[],o=[];return e.forEach(function(e,n){switch(e.IsMindMustInput&&o.push(e),e.SelectNodeMode){case"SelectedNode":e.IsLastReturnNode?e.checked=!1:e.checked=!0,e=i()(e,t.computedUserIsSelected(e));break;case"SelectedAndDisabled":e.checked=!0,e=i()(e,t.computedUserIsSelected(e));break;default:e.checked=!1,e=i()(e,t.computedUserIsSelected(e))}!e.IsCancel&&s.push(e)}),1===s.length&&(s[0].checked=!0),o.length>0?this.IsMindMustInput=!0:this.IsMindMustInput=!1,s},computedUserIsSelected:function(e){var t=e.CanSelectUsers||[],s=e.CanSelectCopyUsers||[];switch(e.SelectUserMode){case"DeselectAll":t.forEach(function(e,t){e.checked=!1});break;case"SelectAll":case"SelectAllAndDisabled":t.forEach(function(t,s){e.checked?t.checked=!0:t.checked=!1});break;default:t.forEach(function(s,o){e.checked&&1===t.length?s.checked=!0:s.checked=!1})}return s.forEach(function(t,o){e.checked&&1===s.length?t.checked=!0:t.checked=!1}),{CanSelectUsers:t,CanSelectCopyUsers:s}},selectItem:function(e){this.selectedWorkFlows.map(function(e){return e.WorkFlowID}).includes(e.WorkFlowID)?this.selectedWorkFlows=[]:this.selectedWorkFlows=[e]},getCurrentFlowItem:function(){return this.selectedWorkFlows[0]},_findUnormalNodeList:function(){return this.NodeLists.filter(function(e){if(!e.Status)return e})},_normalNodeIsShow:function(e){return"Normal"!==e.SendUserMode||!this.filterNormalNode},_tranformStatus:function(e){return!0===e?"正常":"异常"},_transformNodeListAction:function(e){var t=e.CanSendUsers,s=e.SendUserMode;if(!t)return"";switch(s){case"ByDraft":return 0===t.length?"选择人员":"二次筛选";case"ByMainNode":return 0===t.length?"选择人员(指定节点定义,微信无法操作)":"二次筛选(指定节点定义,微信无法操作)";case"BySendUser":return"发送时定义"}},_draftUser:function(e){var t=this.currentNodeList=i()({},e);"ByDraft"===t.SendUserMode&&(this.ConfigUserList=[].concat(n()(t.CanSendUsers)),this._openPositionAndUserBlock(t))},_openPositionAndUserBlock:function(e){this.currentRow=i()({},e),this.$refs.positionUserList.load()},_completeByDraft:function(e){var t=this,s=this.currentRow,o=i()(this.positionUserParams,{NodeCode:s.NodeCode,ConfigUserList:e});if(0===e.length)return this.AlertShowEvent("人员不能为空"),!1;this.byDraft.users=[].concat(n()(e)),this.byDraft.NodeCode=s.NodeCode,this.NodeLists.forEach(function(t,o){t.NodeCode===s.NodeCode&&(t.UserList=a()(e),t.CanSendUsers=e,t.Status=!0)}),this.ConfigUserList=[],this.FlowActionData(a()(o)).then(function(){t.ToastShowEvent("完成选择")}).catch(function(e){t.AlertShowEvent(e.message)})},_setTextColor:function(e){return e.Status?"":"action"},_setCanselectUserString:function(e){var t=[].concat(n()(e.CanSendUsers));return e.Status?t.map(function(e){return e.UserName}).join("，"):""},isShow:function(e){return this.currentStop===e},cancel:function(){this.$router.back()}},Object(d.b)(["GetInformCount","FlowActionData","AlertShowEvent","ToastShowEvent"])),destroyed:function(){this.timer&&clearTimeout(this.timer)},components:{PersonSelectList:v.a,XTextarea:w.a,Group:k.a,InlineXSwitch:m,CheckIcon:_.default,LineBreak:h.default,PositionUserList:f.a}},y={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("transition",{attrs:{name:"slide"}},[s("div",{staticClass:"work-node-select"},[s("div",{directives:[{name:"show",rawName:"v-show",value:e.isShow("selectFlow"),expression:"isShow('selectFlow')"}],staticClass:"before-select-content"},[s("div",{staticClass:"workflow-select"},[s("header",{staticClass:"header"},[s("div",{staticClass:"title"},[e._v("\n            流程选择\n          ")])]),e._v(" "),s("line-break"),e._v(" "),e.WorkFlowList.length>0?s("ul",{staticClass:"select-lists"},e._l(e.WorkFlowList,function(t){return s("li",{key:t.WorkFlowID,staticClass:"select-list",on:{click:function(s){e.selectItem(t)}}},[s("person-select-list",{ref:"personSelectList",refInFor:!0,attrs:{selectedWorkFlows:e.selectedWorkFlows,item:t}})],1)})):e._e()],1),e._v(" "),s("div",{staticClass:"person-select-bar"},[s("div",{staticClass:"select-bar",on:{click:function(t){e.toNextStep("nodeSelect")}}},[s("span",[e._v("下一步")])]),e._v(" "),s("div",{staticClass:"select-bar",on:{click:e.cancel}},[s("span",[e._v("返回")])])])]),e._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:e.isShow("nodeSelect"),expression:"isShow('nodeSelect')"}],staticClass:"node-select-content"},[s("div",{staticClass:"node-select"},[s("header",{staticClass:"header"},[s("div",{staticClass:"title"},[e._v("\n            节点选择\n          ")]),e._v(" "),s("div",{staticClass:"toggle-bar"},[s("cube-switch",{staticClass:"toggle-switch",model:{value:e.filterNormalNode,callback:function(t){e.filterNormalNode=t},expression:"filterNormalNode"}})],1)]),e._v(" "),s("line-break"),e._v(" "),s("ul",{staticClass:"node-select-lists"},e._l(e.NodeLists,function(t,o){return s("li",{directives:[{name:"show",rawName:"v-show",value:e._normalNodeIsShow(t),expression:"_normalNodeIsShow(item)"}],key:o,staticClass:"node-select-list"},[s("div",{staticClass:"list-inner"},[s("div",{staticClass:"list-inner-header"},[s("div",{staticClass:"node-name"},[s("span",{staticClass:"name"},[e._v("节点名称:")]),e._v(" "),s("span",{staticClass:"text"},[e._v(e._s(t.NodeName))])]),e._v(" "),s("div",{staticClass:"node-status"},[s("span",{staticClass:"name"},[e._v("节点状态:")]),e._v(" "),s("span",{staticClass:"text"},[e._v(e._s(e._tranformStatus(t.Status)))])])]),e._v(" "),s("div",{staticClass:"list-inner-body"},[s("div",{staticClass:"node-info"},[s("span",{staticClass:"name"},[e._v("节点描述:")]),e._v(" "),s("span",{staticClass:"text"},[e._v(e._s(t.ShowUserInfo))])]),e._v(" "),s("div",{staticClass:"node-info"},[s("span",{staticClass:"name"},[e._v("可选人员:")]),e._v(" "),s("span",{staticClass:"text"},[e._v(e._s(e._setCanselectUserString(t)))])]),e._v(" "),s("div",{staticClass:"node-action"},[s("span",{staticClass:"name"},[e._v("操作:")]),e._v(" "),s("span",{class:"text "+e._setTextColor(t),on:{click:function(s){s.preventDefault(),s.stopPropagation(),e._draftUser(t)}}},[e._v("\n                      "+e._s(e._transformNodeListAction(t))+"\n                  ")])])])])])}))],1),e._v(" "),s("div",{staticClass:"person-select-bar"},[s("div",{staticClass:"select-bar",on:{click:function(t){e.toNextStep("peopleSelect")}}},[s("span",[e._v("下一步")])]),e._v(" "),"view"!==e.formState?s("div",{staticClass:"select-bar",on:{click:function(t){e.toUpStep("selectFlow")}}},[s("span",[e._v("上一步")])]):e._e()])]),e._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:e.isShow("peopleSelect"),expression:"isShow('peopleSelect')"}],staticClass:"after-select-content"},[s("div",{staticClass:"people-select"},[s("header",{staticClass:"header"},[s("div",{staticClass:"title"},[e._v("\n            人员选择\n          ")]),e._v(" "),s("div",{staticClass:"toggle-bar"},[s("cube-switch",{staticClass:"toggle-switch",model:{value:e.showPeopleContent,callback:function(t){e.showPeopleContent=t},expression:"showPeopleContent"}})],1)]),e._v(" "),s("section",{staticClass:"people-content",style:{height:e.PeopleContentHeight}},e._l(e.NextNodeList,function(t,o){return s("div",{key:o,staticClass:"next-node-list"},[s("h1",{staticClass:"node-list-title",on:{click:function(t){e.nodeListTitleSelect(o)}}},[s("div",{staticClass:"name"},[e._v(e._s(t.NodeName))]),e._v(" "),s("div",{staticClass:"check-box"},[s("check-icon",{attrs:{checked:t.checked}})],1)]),e._v(" "),t.CanSelectUsers.length>0?s("div",{staticClass:"next-node-list-unit can-select-users"},[s("h1",{staticClass:"title"},[e._v("可送审人员")]),e._v(" "),s("ul",{staticClass:"people-lists"},e._l(t.CanSelectUsers,function(t,n){return s("li",{key:n,staticClass:"people-list",on:{click:function(t){e.selectUsersEvent(o,n)}}},[s("div",{staticClass:"user-name"},[e._v(e._s(t.UserName))]),e._v(" "),s("div",{staticClass:"check-box"},[s("check-icon",{attrs:{checked:t.checked}})],1)])}))]):e._e(),e._v(" "),t.CanSelectCopyUsers.length>0?s("div",{staticClass:"next-node-list-unit can-select-copy-users"},[s("h1",{staticClass:"title"},[e._v("可抄送人员")]),e._v(" "),s("ul",{staticClass:"people-lists"},e._l(t.CanSelectCopyUsers,function(t,n){return s("li",{key:n,staticClass:"people-list",on:{click:function(t){e.selectCopyUsersEvent(o,n)}}},[s("div",{staticClass:"user-name"},[e._v(e._s(t.UserName))]),e._v(" "),s("div",{staticClass:"check-box"},[s("check-icon",{attrs:{checked:t.checked}})],1)])}))]):e._e()])})),e._v(" "),s("section",{staticClass:"approve-text-content"},[s("h1",{staticClass:"text-title"},[e._v("审批意见")]),e._v(" "),s("group",{staticClass:"textarea-content"},[s("x-textarea",{attrs:{name:"description",max:300,placeholder:"输入审批意见"},model:{value:e.MindInfo,callback:function(t){e.MindInfo="string"==typeof t?t.trim():t},expression:"MindInfo"}})],1)],1)]),e._v(" "),s("div",{staticClass:"person-select-bar"},[s("div",{staticClass:"select-bar",on:{click:e.submitFlow}},[s("span",[e._v("提交")])]),e._v(" "),"view"!==e.formState?s("div",{staticClass:"select-bar",on:{click:function(t){e.toUpStep("nodeSelect")}}},[s("span",[e._v("上一步")])]):e._e()])]),e._v(" "),s("position-user-list",{ref:"positionUserList",attrs:{subParams:e.positionUserParams,currentUserList:e.ConfigUserList},on:{complete:e._completeByDraft}})],1)])},staticRenderFns:[]};var U=s("VU/8")(I,y,!1,function(e){s("EEJi")},null,null);t.default=U.exports},undV:function(e,t,s){"use strict";var o={props:{selectedWorkFlows:{type:Array,default:function(){return[]}},item:{type:Object,default:function(){return{}}}},computed:{WorkFlowIDs:function(){return this.selectedWorkFlows.map(function(e){return e.WorkFlowID})},checked:function(){return this.WorkFlowIDs.includes(this.item.WorkFlowID)}}},n={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"person-select-list"},[s("div",{staticClass:"person-select-item title"},[s("p",{staticClass:"text"},[e._v(e._s(e.item.WorkFlowName))])]),e._v(" "),s("div",{staticClass:"person-select-item select-box"},[s("div",{staticClass:"check-icon-wrap"},[s("div",{staticClass:"vux-check-icon"},[e.checked?s("i",{staticClass:"weui-icon weui_icon_success weui-icon-success"}):e._e(),e._v(" "),e.checked?e._e():s("i",{staticClass:"weui-icon weui_icon_circle weui-icon-circle"})])])])])},staticRenderFns:[]};var c=s("VU/8")(o,n,!1,function(e){s("S9wd")},null,null);t.a=c.exports}});
//# sourceMappingURL=2.f053c55f070432765a0d.js.map